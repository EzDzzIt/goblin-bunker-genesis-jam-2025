#include <genesis.h>
#include "resources.h"
#include "globals.h"
#include "player.h"
#include "level.h"
#include "enemy.h"
#include "game.h"
#include "spell.h"

// global variables

InputType input;

// enum game_state_enum game_state = GAME_STATE_GAME;
enum game_state_enum game_state = GAME_STATE_TITLE;

u8 title_counter = 0;
u16 global_counter = 0;
bool title_skip = false;
bool has_key = false;
bool secret_triggered = false;
u16 score = 0;
u8 doors_closed = 0;
u8 total_doors_closed = 0;
u8 enemies_killed = 0;
u16 total_enemies_killed = 0;
u8 secrets_found = 0;
u8 level_timer = 0;
u8 level_state = 0;
s8 SCROLL_X = 0;
s8 SCROLL_Y = 0;
u8 MAP_X = 0;
u8 MAP_Y = 0; // these represent the region of the tilemap we are in
void *current_map_data;
u8 current_map_data_columns = 0;
bool UPDATE_SCROLL = FALSE;
TileMap *currentMap;
u8 current_level = 0;

bool collision_check(s16 x, s16 y, u8 w, u8 h, s16 x2, s16 y2, u8 w2, u8 h2)
{
    if (x > x2 + w2)
    {
        return false;
    }
    if (x + w < x2)
    {
        return false;
    }
    if (y + h < y2)
    {
        return false;
    }
    if (y > y2 + h2)
    {
        return false;
    }
    if (x < x2 + w2 && x + w > x2 && y < y2 + h2 && y + h > y2)
    {
        return true;
    }
    else
    {
        return false;
    }
}

void setSprite(Sprite *sprite, fix16 x, fix16 y)
{
    SPR_setPosition(sprite, x - SCROLL_X * 8, y - SCROLL_Y * 8);
}

void clear_graphics(bool stop_music)
{
    // start by cleaning up old level memory
    VDP_clearTileMap(BG_A, 0, 400, TRUE);
    VDP_clearTileMap(BG_B, 0, 400, TRUE);
    // VDP_clearTileMap(BG_B, 0, 200, TRUE);
    VDP_clearTileMapRect(BG_A, 0, 0, 32, 28);
    VDP_clearTileMapRect(BG_B, 0, 0, 32, 28);
    VDP_clearSprites();
    SPR_clear();
    SPR_reset();
    SPR_defragVRAM();
    if (stop_music)
    {
        XGM2_stop();
    }
}

void reset_globals()
{

    global_counter = 1; // reset for new level
    UPDATE_SCROLL = false;
    MAP_X = 0;
    MAP_Y = 0;
    SCROLL_X = 0;
    SCROLL_Y = 0;
    doors_closed = 0;
    enemies_killed = 0;
    level_state = 0;
    has_key = false;
    secret_triggered = false;

    SPR_setAnim(player.sprite, PLAYER_ANIM_IDLE);

    u8 i = 0;
    for (i = 0; i < MAX_SACRED_GROUND; i++)
    {
        if (sacred_ground_array[i].data.active)
        {
            sacred_ground_array[i].lifetime = 0;
            sacred_ground_array[i].data.active = FALSE;
            SPR_releaseSprite(sacred_ground_array[i].data.sprite);
        }
    }
    for (i = 0; i < MAX_OBJECTS; i++)
    {
        if (level_object_array[i].data.active)
        {
            level_object_array[i].data.active = FALSE;
            SPR_releaseSprite(level_object_array[i].data.sprite);
        }
    }
    for (i = 0; i < MAX_DOORS; i++)
    {
        if (door_array[i].data.active)
        {
            door_array[i].data.active = FALSE;
            SPR_releaseSprite(door_array[i].data.sprite);
            if (door_array[i].beastmode)
            {
                door_array[i].beastmode = FALSE;
                // SPR_releaseSprite(door_array[i].beastmode_sprite);
            }
            SPR_releaseSprite(door_array[i].beastmode_sprite);
        }
    }
    for (i = 0; i < MAX_ENEMIES; i++)
    {
        if (enemy_array[i].data.active)
        {
            enemy_array[i].data.active = FALSE;
            SPR_releaseSprite(enemy_array[i].data.sprite);
        }
    }
    for (i = 0; i < MAX_BULLETS; i++)
    {
        if (bullet_array[i].data.active)
        {
            bullet_array[i].data.active = FALSE;
            SPR_releaseSprite(bullet_array[i].data.sprite);
        }
    }
    for (i = 0; i < MAX_BULLETS; i++)
    {
        if (player_bullet_array[i].data.active)
        {
            player_bullet_array[i].data.active = FALSE;
            SPR_releaseSprite(player_bullet_array[i].data.sprite);
        }
    }
}

const u8 level_1_map_data[16][20] = {
    {4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5},
    {2, 1, 1, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 11, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 11, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 11, 12, 11, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 11, 13, 11, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 11, 11, 11, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {3, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6},
};

const u8 level_2_map_data[16][20] = {
    {4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5},
    {2, 1, 1, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 11, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1, 7},
    {2, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 11, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1, 7},
    {2, 4, 8, 5, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1, 1, 7},
    {2, 2, 10, 7, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1, 1, 7},
    {2, 2, 10, 7, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 1, 11, 1, 1, 7},
    {2, 2, 10, 7, 1, 1, 1, 1, 1, 11, 11, 11, 11, 1, 11, 11, 11, 11, 1, 7},
    {2, 3, 9, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {3, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6},

};

const u8 level_3_map_data[16][20] = {
    {4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5},
    {2, 1, 1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5, 7},
    {2, 1, 1, 11, 1, 1, 1, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7, 7},
    {2, 1, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6, 7},
    {2, 1, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 11, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 11, 11, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 8, 8, 5, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 11, 1, 1, 1, 1, 1, 1, 2, 8, 8, 7, 7},
    {2, 1, 1, 1, 1, 11, 11, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 16, 1, 1, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 11, 1, 1, 1, 1, 1, 16, 9, 9, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 12, 1, 12, 1, 12, 1, 12, 1, 3, 9, 9, 6, 7},
    {2, 1, 1, 1, 1, 1, 1, 13, 11, 13, 1, 13, 1, 13, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 11, 11, 1, 1, 1, 1, 1, 11, 11, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {3, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6},

};

const u8 level_4_map_data[16][40] = {
    {4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5, 4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 8, 8, 8, 5, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 1, 1, 1, 1, 11, 14, 14, 10, 1, 1, 1, 1, 2, 1, 1, 1, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 1, 1, 1, 1, 10, 10, 14, 1, 1, 1, 1, 1, 2, 1, 1, 1, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 1, 1, 1, 1, 1, 14, 14, 1, 1, 1, 1, 1, 2, 1, 1, 1, 7, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 18, 17, 17, 17, 19, 7},
    {2, 1, 1, 1, 1, 1, 1, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 10, 1, 1, 1, 10, 1, 1, 10, 10, 1, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 26, 1, 1, 10, 1, 1, 1, 1, 1, 1, 11, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 1, 1, 1, 1, 26, 26, 26, 1, 11, 11, 11, 1, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 26, 26, 26, 26, 26, 26, 1, 26, 1, 10, 10, 10, 14, 11, 1, 14, 10, 10, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 26, 26, 26, 28, 28, 28, 1, 1, 1, 14, 1, 1, 10, 1, 1, 10, 10, 10, 7},
    {2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 7, 2, 1, 26, 26, 26, 28, 28, 28, 1, 1, 1, 1, 1, 1, 1, 10, 10, 10, 10, 7},
    {3, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6, 3, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6},

};

const u8 level_5_map_data[16][20] = {
    {4, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 5},
    {2, 10, 10, 10, 1, 1, 1, 1, 12, 26, 26, 12, 1, 1, 1, 1, 10, 10, 10, 7},
    {2, 10, 10, 10, 10, 1, 1, 1, 13, 26, 26, 13, 1, 1, 1, 1, 10, 10, 1, 7},
    {2, 1, 10, 10, 1, 10, 1, 1, 26, 1, 1, 26, 1, 1, 1, 1, 10, 10, 10, 7},
    {2, 1, 10, 1, 1, 10, 2, 1, 1, 26, 26, 1, 1, 7, 10, 1, 10, 10, 1, 7},
    {2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 7, 1, 1, 1, 1, 1, 7},
    {2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 7, 1, 1, 7, 1, 1, 7},
    {2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 7, 1, 1, 7, 1, 1, 7},
    {2, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 7, 1, 1, 7, 1, 1, 7},
    {2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 7, 1, 1, 1, 1, 1, 7},
    {2, 1, 10, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 7, 1, 1, 1, 1, 1, 7},
    {2, 10, 10, 1, 10, 1, 10, 10, 1, 1, 1, 1, 1, 1, 1, 1, 10, 10, 10, 7},
    {2, 1, 10, 10, 10, 10, 10, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 10, 10, 7},
    {2, 10, 10, 1, 10, 10, 10, 1, 1, 1, 1, 1, 1, 1, 1, 10, 10, 10, 10, 7},
    {2, 10, 10, 1, 10, 10, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 10, 10, 10, 7},
    {3, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 6},

};

// const u8 level_3_map_data[16][20] = {
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},
//     {},

// };